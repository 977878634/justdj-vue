webpackJsonp([11],{"+HGy":function(t,e){},"8O/1":function(t,e,s){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=s("3cXf"),o=s.n(i),n=s("hRKE"),a=s.n(n),r=(s("YtJ0"),s("MS2J")),c=s("HGBG"),l=s("iVC1"),d={name:"messagePage",components:{VueEditor:c.VueEditor},data:function(){return{myScrollbar:{},user:{},token:"",websocket:null,content:"",inputData:"",message:{toUserType:0,messageType:0,from:"",to:"",fromUserName:"",toUserName:"",data:""},toUserId:"",messageList:[],userList:[]}},computed:{},methods:{contains:function(t,e){return-1!=t.indexOf(e)},isEmpty:function(t){switch(void 0===t?"undefined":a()(t)){case"undefined":return!0;case"string":if(0===t.replace(/(^[ \t\n\r]*)|([ \t\n\r]*$)/g,"").length)return!0;break;case"boolean":if(!t)return!0;break;case"number":if(0===t||isNaN(t))return!0;break;case"object":if(null===t||0===t.length)return!0;for(var e in t)return!1;return!0}return!1},selectUser:function(t){var e=t.id;t.num=0,e!==this.toUserId?(this.toUserId=e,this.getMessage(e)):console.log("当前用户已被选中")},getMessage:function(t){var e=this;Object(l.n)(t).then(function(t){200===t.code?e.messageList=t.data:e.$message.error("获取聊天记录失败")})},handleContent:function(t){t.from!==this.user.id&&t.from!==this.toUserId||this.messageList.push(JSON.parse(o()(t))),"system"===t.from||(t.from!==this.toUserId?this.getRecentUserAndNumList():this.getMessage(this.toUserId))},addUserToRecentList:function(t){var e=this,s=!1;this.userList.forEach(function(e){e.id===t&&(s=!0)}),!0!==s&&Object(l.o)(t).then(function(t){200===t.code?e.userList.push(t.data):console.log("获取用户信息失败")})},addGroupUserToRecentList:function(t){var e=this,s=[],i="";t.forEach(function(t){return s.push(t.id)}),s.forEach(function(t){e.userList.forEach(function(e){e.id===t&&(!0,i=e.id)})}),r.c(i)?console.log("当前用户不在历史聊天用户中"):(console.log("当前用户有过聊天记录，清除用户列表"),this.userList=[]),Object(l.k)(s).then(function(s){200===s.code?r.c(s.data)||(s.data.forEach(function(e){t.forEach(function(t){t.id===e.id&&(e.num=t.num)})}),e.userList=s.data):console.log("获取最近联系人详细信息失败")})},closeWebSocket:function(){this.websocket.close()},send:function(t){this.messageList.push(JSON.parse(o()(t))),this.websocket.send(o()(t))},sizeof:function(t,e){var s=0,i=void 0,o=void 0,n=void 0;if("utf-16"===(e=e?e.toLowerCase():"")||"utf16"===e)for(o=0,n=t.length;o<n;o++)s+=(i=t.charCodeAt(o))<=65535?2:4;else for(o=0,n=t.length;o<n;o++)s+=(i=t.charCodeAt(o))<=127?1:i<=2047?2:i<=65535?3:4;return s},scrollDown:function(){this.$refs.myScrollbar.wrap.scrollTop=this.$refs.myScrollbar.wrap.scrollHeight},goUp:function(){this.$router.go(-1)},sendToUserMessage:function(t,e){r.c(this.inputData)?this.$message.info("信息不能为空"):(console.log("数据长度 "+this.sizeof(this.inputData,"UTF-8")),this.sizeof(this.inputData,"UTF-8")>204800?this.$message.info("数据太大"):(this.message.from=this.user.id,this.message.to=e,this.message.data=this.inputData+"",this.message.toUserType=0,this.message.messageType=1,this.message.fromUserName=this.user.name,this.send(this.message),this.inputData=""))},sendToAllUserMessage:function(t,e){r.c(this.inputData)?this.$message.info("信息不能为空"):this.sizeof(this.inputData,"UTF-8")>204800?this.$message.info("数据太大"):(this.message.from=this.user.id,this.message.to=e,this.message.data=this.inputData.concat(""),this.message.toUserType=0,this.message.messageType=1,this.message.fromUserName=this.user.name,this.send(message),this.inputData="")},getRecentUserAndNumList:function(){var t=this;Object(l.m)({}).then(function(e){console.log("获取最近联系人接口调用"),200===e.code?t.addGroupUserToRecentList(e.data):console.log("获取最近联系人失败")})}},updated:function(){this.scrollDown()},mounted:function(){var t=this;if(this.user=JSON.parse(localStorage.getItem("user")),this.token=localStorage.getItem("token"),r.c(this.user)&&this.$store.commit("signInDialogVisibleTrue"),this.toUserId=this.$route.query.id,this.getRecentUserAndNumList(),r.c(this.toUserId)||(t.addUserToRecentList(this.toUserId),t.getMessage(this.toUserId)),"WebSocket"in window){var e="ws://"+"http://47.102.199.98:9003".toString().replace("http://","")+"/api/webSocket/";console.log("地址 "+e),this.websocket=new WebSocket(e+this.token)}else alert("Not support websocket");this.websocket.onerror=function(e){t.$message.error("webSocket 连接错误"+e.code)},this.websocket.onopen=function(e){t.$message.success("webSocket 会话连接成功")},this.websocket.onmessage=function(e){var s=JSON.parse(e.data);console.log("收到的消息 "+o()(s)),-1===s.messageType?console.log("连接信息 不予显示"):t.handleContent(s)},this.websocket.onclose=function(){t.$message.info("webSocket 连接已关闭")},window.onbeforeunload=function(){t.websocket.close()}}},h={render:function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("section",[s("div",{staticStyle:{width:"100%",height:"100%",display:"flex","justify-content":"flex-start","align-items":"center"}},[s("div",{staticStyle:{width:"15%",height:"100%",display:"flex","flex-direction":"column","justify-content":"flex-start","align-items":"center"}},[s("div",{staticStyle:{display:"flex","justify-content":"flex-start",width:"100%"}},[s("el-button",{staticStyle:{margin:"0"},attrs:{icon:"el-icon-arrow-left"},on:{click:t.goUp}})],1),t._v(" "),s("span",{staticStyle:{"font-size":"18px","font-weight":"bold","margin-bottom":"15px","margin-top":"10px"}},[t._v("最近联系列表")]),t._v(" "),t._l(t.userList,function(e){return s("div",{staticClass:"user_item",staticStyle:{width:"100%",height:"40px","margin-bottom":"10px"},on:{click:function(s){return t.selectUser(e)}}},[s("el-badge",{staticClass:"item",attrs:{value:e.num,hidden:e.num<=0||e.id===t.toUserId}},[s("el-card",{class:{user_item_select:t.toUserId===e.id},staticStyle:{width:"100%",height:"100%",display:"flex","justify-content":"flex-start","align-items":"center"},attrs:{shadow:"hover"}},[s("span",{staticStyle:{"margin-right":"10px","font-size":"16px","font-weight":"bold"}},[t._v(t._s(e.name))]),t._v(" "),s("span",{staticStyle:{overflow:"hidden","white-space":"nowrap","text-overflow":"ellipsis"}},[t._v(t._s(e.password))])])],1)],1)})],2),t._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:!t.isEmpty(t.toUserId),expression:"!isEmpty(toUserId)"}],staticClass:"chat-body",staticStyle:{width:"85%",height:"100%","max-height":"100%","box-sizing":"border-box",overflow:"hidden",display:"flex","flex-direction":"column","justify-content":"flex-start","align-items":"left"}},[s("div",{staticStyle:{width:"85%",height:"58%","max-height":"58%","margin-bottom":"1.5%"}},[s("el-scrollbar",{ref:"myScrollbar"},t._l(t.messageList,function(e){return s("div",[s("el-row",{staticStyle:{width:"100%"}},[e.from!==t.user.id&&"system"!==e.from?s("el-col",{staticStyle:{"margin-bottom":"10px",display:"flex","justify-content":"flex-start","align-items":"center"},attrs:{span:18,offset:0}},[s("span",{staticStyle:{"font-size":"16px","font-weight":"bold"}},[t._v(t._s(e.fromUserName)+"  : ")]),t._v(" "),s("el-card",{attrs:{shadow:"hover"}},[s("span",{domProps:{innerHTML:t._s(e.data)}})])],1):t._e(),t._v(" "),e.from===t.user.id?s("el-col",{staticStyle:{"margin-bottom":"10px",display:"flex","justify-content":"flex-end","align-items":"center"},attrs:{span:18,offset:6}},[s("el-card",{attrs:{shadow:"hover"}},[s("span",{domProps:{innerHTML:t._s(e.data)}})]),t._v(" "),s("span",{staticStyle:{"font-size":"16px","font-weight":"bold"}},[t._v(" : "+t._s(t.user.name)+" ")])],1):t._e(),t._v(" "),"system"===e.from?s("el-col",{staticStyle:{display:"flex","justify-content":"center","align-items":"center","margin-bottom":"10px"},attrs:{span:24}},[s("el-card",{attrs:{shadow:"hover"}},[s("span",{staticStyle:{color:"#e6a23c"}},[t._v("系统消息: "+t._s(e.data))])])],1):t._e()],1)],1)}),0)],1),t._v(" "),s("div",{staticClass:"tool-pane",staticStyle:{height:"40%","max-height":"40%",width:"100%",display:"flex","justify-content":"flex-start","align-items":"left"}},[s("vue-editor",{staticStyle:{width:"85%",height:"80%","min-height":"0"},model:{value:t.inputData,callback:function(e){t.inputData=e},expression:"inputData"}}),t._v(" "),s("div",{staticClass:"pane-button",staticStyle:{width:"15%",height:"100%",display:"flex","flex-direction":"column","justify-content":"flex-start"}},[s("div",{staticStyle:{"margin-bottom":"15px","margin-top":"15px"}},[s("el-button",{on:{click:function(e){return t.sendToUserMessage(t.inputData,t.toUserId)}}},[t._v("发送消息\n            ")])],1),t._v(" "),s("div",{staticStyle:{"margin-bottom":"15px"}},[s("el-button",{on:{click:function(e){t.inputData=""}}},[t._v("清空输入")])],1),t._v(" "),s("div",{staticStyle:{"margin-bottom":"15px"}},[s("el-button",[t._v("删除记录")])],1),t._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:!t.contains(t.user.roleId,2),expression:"!contains(user.roleId,2)"}],staticStyle:{"margin-bottom":"15px"}},[s("el-button",[t._v("发送简历")])],1),t._v(" "),s("div",{directives:[{name:"show",rawName:"v-show",value:t.contains(t.user.roleId,2),expression:"contains(user.roleId,2)"}],staticStyle:{"margin-bottom":"15px"}},[s("el-button",[t._v("要简历")])],1)])],1)])])])},staticRenderFns:[]};var u=s("C7Lr")(d,h,!1,function(t){s("+HGy")},"data-v-0d5ed569",null);e.default=u.exports}});